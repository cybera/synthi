#!/bin/bash

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
PROJECT_DIR="$(dirname $SCRIPT_DIR)"

cd $PROJECT_DIR/test

action=$1

if [[ $action == 'start' ]]; then
  docker-compose up -d
  docker-compose exec -T neo4j bash -c '
    echo "Waiting for Neo4J to start up"
    end="$((SECONDS+60))"
    while true; do
      [[ "200" = "$(curl --silent --write-out %{http_code} --output /dev/null http://localhost:7474)" ]] && break
      [[ "${SECONDS}" -ge "${end}" ]] && exit 1
      sleep 1
    done
  '
  docker-compose exec -T python-worker /usr/src/app/create_user.py test password test-token
  docker-compose exec -T python-worker /usr/src/app/create_user.py test2 password test-token2
  docker-compose exec -T python-worker /usr/src/app/create_org.py shared-test-org
  docker-compose exec -T python-worker /usr/src/app/add_user_to_org.py test shared-test-org
  docker-compose exec -T python-worker /usr/src/app/add_user_to_org.py test2 shared-test-org
  docker-compose exec -T python-worker /usr/src/app/run_migrations.py
elif [[ $action == 'stop' ]]; then
  docker-compose down -v
  docker-compose rm -v
else
    echo "\"$action\" is not a valid subcommand for $0"
    exit 1
fi
