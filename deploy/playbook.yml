---
- hosts: all
  remote_user: ubuntu
  become: yes
  tasks:
    - name: add certbot ppa
      apt_repository:
        repo: ppa:certbot/certbot
    - name: install certbot
      apt:
        name: python-certbot-nginx
        state: latest
    - name: install nginx
      apt:
        name: nginx
        state: latest
    - name: request ssl certificate
      command: certbot --nginx --non-interactive --agree-tos -m adi@cybera.ca -d {{ inventory_hostname }}
    - name: setup automatic certificate renewal
      cron:
        name: certbot renew
        special_time: daily
        job: certbot renew
    - name: write nginx site configuration
      template:
        src: templates/site.j2
        dest: /etc/nginx/sites-enabled/default
      notify:
        - restart nginx
    - name: write docker daemon configuration
      template:
        src: templates/daemon.json.j2
        dest: /etc/docker/daemon.json
      notify:
        - restart docker
    - name: Check if swarm has already been initialized
      shell: docker node ls
      register: swarm_status
      ignore_errors: true
    - name: initialize docker swarm
      command: docker swarm init
      when: swarm_status.rc != 0
      run_once: true
    - name: create create-user script
      template:
        src: templates/create-user.j2
        dest: /usr/local/bin/create-user
        owner: ubuntu
        group: ubuntu
        mode: 0744
    - name: create create-org script
      template:
        src: templates/create-org.j2
        dest: /usr/local/bin/create-org
        owner: ubuntu
        group: ubuntu
        mode: 0744
    - name: create add-user-to-org script
      template:
        src: templates/add-user-to-org.j2
        dest: /usr/local/bin/add-user-to-org
        owner: ubuntu
        group: ubuntu
        mode: 0744
    
  handlers:
    - name: restart nginx
      service:
        name: nginx
        state: restarted
    - name: restart docker
      service:
        name: docker
        state: restarted
